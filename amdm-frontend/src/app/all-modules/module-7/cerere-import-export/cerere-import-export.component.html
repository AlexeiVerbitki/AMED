<div class="container-fluid sky z-depth-2">
    <h3 class="text-center my-3 font-weight-bold">Cerere de autorizare a importului/exportului
        precursorilor/psihotropelor/stupefiantelor</h3>

    <hr>
    <form [formGroup]='cerereImpExpForm'>

        <app-document [documents]="documents" [nrCerere]="cerereImpExpForm.get('requestNumber').value"
                      [dcTypes]="docTypes" (documentModified)="documentModified($event)"></app-document>
        <hr>

        <div class="row">

            <div class="col-md-4">
                <div class="md-form-modified">
                    <mat-form-field class="w-100">
                        <input matInput [matDatepicker]="picker" placeholder="Data inregistrarii" required
                               formControlName="data">
                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker touchUi #picker></mat-datepicker>
                    </mat-form-field>
                </div>
            </div>
            <div class="col-md-4">
                <div class="md-form">
                    <input id="nrReg" mdbInputDirective type="text" class="form-control" formControlName="requestNumber"
                           [attr.disabled]="true">
                    <label for="nrReg">Nr. de inregistrare a cererii
                        <span class="text-danger">*</span>
                    </label>
                </div>
            </div>
            <div class="col-md-4">
                <div class="md-form">
                    <div class="md-form">
                        <input id="compSolicitant" mdbInputDirective type="text" class="form-control"
                               formControlName="companyValue" [attr.disabled]="true">
                        <label for="compSolicitant">Compania solicitant</label>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="md-form">
                    <ng-select class="custom"
                               [items]="authorizationTypes"
                               bindLabel="viewValue"
                               formControlName="authorizationType"
                               placeholder="Tipul autorizarii">
                    </ng-select>
                    <div *ngIf="formSubmitted && !cerereImpExpForm.get('authorizationType').valid">
                        <small class="text-muted"><strong class="text-danger">Tipul autorizarii trebuie
                            selectat</strong>
                        </small>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="row">
                    <div class="col-2">
                        <div class="md-form">
                            <mat-checkbox formControlName="precursor">Precursori</mat-checkbox>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="md-form">
                            <mat-checkbox formControlName="psihotrop">Psihotrope</mat-checkbox>
                        </div>
                    </div>
                    <div class="col-2">
                        <div class="md-form">
                            <mat-checkbox formControlName="stupefiant">Stupefiante</mat-checkbox>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="md-form-modified" formGroupName="selectedMedicaments">
                    <ng-select class="custom" [items]="medicamente | async"
                               bindLabel="name"
                               placeholder="Medicamente"
                               formControlName="selectedMedicament"
                               [required]="false"
                               [typeahead]="medInputs"
                               [loading]="medLoading">
                        <ng-template ng-option-tmp let-item="item">
                            {{item.name}} <br/>
                            <small>{{item.code}}</small>
                        </ng-template>
                    </ng-select>
                    <div *ngIf="medicamentNotSelected">
                        <small class="text-muted"><strong class="text-danger">Medicamentul trebuie
                            selectat</strong></small>
                    </div>
                    <div *ngIf="medicamentExistInTable">
                        <small class="text-muted"><strong class="text-danger">Medicamentul este deja adaugat
                        </strong></small>
                    </div>
                </div>
            </div>
        </div>

        <hr>
        <div class="row">
            <div class="col-md-4">
                <div class="md-form" formGroupName="medicament">
                    <input id="tipMedicament" mdbInputDirective type="text" class="form-control"
                           formControlName="medicamentType">
                    <label for="tipMedicament">Tipul medicamentului
                    </label>
                </div>
            </div>
            <div class="col-md-4">
                <div class="md-form" formGroupName="medicament">
                    <input id="cod" mdbInputDirective type="text" class="form-control"
                           formControlName="code">
                    <label for="cod">Codul medicamentului
                    </label>
                </div>
            </div>

            <div class="col-md-4">
                <div class="md-form" formGroupName="medicament">
                    <input id="cantitateMed" mdbInputDirective type="text" class="form-control"
                           formControlName="volume">
                    <label for="cantitateMed">Cantitatea medicamentului
                    </label>
                </div>
            </div>
            <div class="col-md-4">
                <div class="md-form" formGroupName="medicament">
                    <input id="forma" mdbInputDirective type="text" class="form-control"
                           formControlName="pharmaceuticalForm">
                    <label for="forma">Forma
                    </label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-9">
                        <div class="md-form" formGroupName="medicament">
                            <input id="doza" mdbInputDirective type="text" class="form-control"
                                   formControlName="dose">
                            <label for="doza">Doza
                            </label>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="md-form" formGroupName="medicament">
                            <input id="volum" mdbInputDirective type="text" class="form-control"
                                   formControlName="volumeQuantityMeasurement">
                            <label for="volum">Volum
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="md-form" formGroupName="medicament">
                    <input id="seria" mdbInputDirective type="text" class="form-control" formControlName="serialNr">
                    <label for="seria">Seria
                    </label>
                </div>
            </div>
        </div>

        <hr>

        <h6 class="text-center font-weight-normal">Substante active</h6>
        <table class="table table-widths text-center">
            <thead class="black white-text">
            <tr>
                <th scope="col">Denumire</th>
                <th scope="col">Cantitate</th>
                <th scope="col">Unitate de masurÄƒ</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let substance of activeSubstancesTable;let i = index">
                <th scope="row">{{ substance.activeSubstance.description }}</th>
                <td>{{ substance.quantity }}</td>
                <td>{{ substance.unitsOfMeasurement.description }}</td>
            </tr>
            </tbody>
        </table>

        <hr>
        <div class="text-center">
            <button class="btn btn-dark-green-color waves-light btn-sm btn-sm-bl" mdbWavesEffect
                    (click)="addMedicament()">Adaugare Medicament
            </button>
        </div>
        <hr>
        <h5 class="text-center font-weight-bold">Medicamente selectate</h5>
        <table class="table table-widths text-center">
            <thead class="black white-text">
            <tr>
                <th scope="col">Denumire</th>
                <th scope="col">Cod</th>
                <th scope="col">Actiuni</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let medicament of selectedMedicamentsTable;let i = index">
                <td>{{ medicament.name }}</td>
                <td>{{ medicament.code }}</td>
                <td>
                    <button type="button" class="btn btn-dark-red-color waves-light btn-sm waves-light"
                            (click)="removeMedicament(i)" mdbWavesEffect attr.disabled="this.disabled">Stergere
                    </button>
                </td>
            </tr>
            </tbody>
        </table>

        <hr>

        <div class="row">
            <div class="col-md-6">
                <div class="md-form" formGroupName="drugCheckDecision">
                    <input id="procesVerbal" mdbInputDirective type="text" class="form-control"
                           formControlName="protocolNr">
                    <label for="procesVerbal">Numarul procesului verbal
                        <span class="text-danger">*</span>
                    </label>
                    <div *ngIf="formSubmitted && cerereImpExpForm.get('drugCheckDecision.protocolNr').invalid">
                        <small class="text-muted"><strong class="text-danger">Numarul procesului verbal trebuie
                            introdus</strong></small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="md-form">
                    <mat-form-field class="w-100" formGroupName="drugCheckDecision">
                        <input matInput [matDatepicker]="pickerCPCAD" placeholder="Data procesului verbal a CPCAD"
                               required formControlName="protocolDate">
                        <mat-datepicker-toggle matSuffix [for]="pickerCPCAD"></mat-datepicker-toggle>
                        <mat-datepicker touchUi #pickerCPCAD></mat-datepicker>
                    </mat-form-field>
                </div>
            </div>
            <div class="col-md-6">
                <div class="md-form">
                    <input id="reason" mdbInputDirective type="text" class="form-control">
                    <label for="reason">Motivul refuzului
                    </label>
                </div>
            </div>
        </div>

        <hr>
        <app-payment [requestId]="cerereImpExpForm.get('id').value"
                     (totalValueChanged)="paymentTotalUpdate($event)"></app-payment>
        <div *ngIf="formSubmitted && paymentTotal<0">
            <small class="text-muted"><strong class="text-danger">Clientul are datorii.</strong></small>
        </div>

        <hr>
        <h5 class="text-center font-weight-bold">Documente de iesire</h5>
        <hr>
        <table class="table table-widths-lg text-center">
            <thead class="black white-text">
            <tr>
                <th scope="col">Denumirea</th>
                <th scope="col">Numar</th>
                <th scope="col">Statut document</th>
                <th scope="col">Statut emitere</th>
                <th>Actiuni</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let a of outDocuments">
                <th scope="row">{{ a.name }}</th>
                <th scope="row">{{ a.number }}</th>
                <th scope="row">{{ a.status }}</th>
                <th scope="row">
                    <mat-checkbox
                            *ngIf="a.docType && (a.docType.category=='SR' || a.docType.category=='IP' || a.docType.category=='IH' || a.docType.category=='IF' || a.docType.category=='EP' || a.docType.category=='EH' || a.docType.category=='EF')"
                            #checkBoxResponse [checked]="a.responseReceived || a.status=='Atasat'"
                            (change)="checkResponseReceived(a,checkBoxResponse)" [disabled]="a.status=='Atasat'">Emitere
                        document
                    </mat-checkbox>
                </th>
                <td>
                    <button class="btn btn-default btn-sm waves-light" mdbWavesEffect (click)="viewDoc(a)">Vizualizare
                    </button>
                    <button *ngIf="a.status=='Nu este atasat' && a.responseReceived==false && (a.docType.category=='SR' || a.docType.category=='IP' || a.docType.category=='IH' || a.docType.category=='IF' || a.docType.category=='EP' || a.docType.category=='EH' || a.docType.category=='EF')"
                            class="btn btn-dark-red-color btn-sm waves-light" mdbWavesEffect (click)="remove(a)">
                        Stergere
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
        <div *ngIf="formSubmitted && !isResponseReceived">
            <small class="text-muted"><strong class="text-danger">Nici un document pentru emitere nu a fost
                selectat</strong></small>
        </div>
        <div *ngIf="formSubmitted && isNonAttachedDocuments && isResponseReceived">
            <small class="text-muted"><strong class="text-danger">Exista documente care nu au fost atasate</strong>
            </small>
        </div>
        <hr>
        <div class="text-center">
            <button class="btn btn-dark-green-color waves-light btn-sm btn-sm-bl" mdbWavesEffect
                    (click)="saveRequest()">Inregistrare
            </button>
            <button class="btn btn-danger waves-light btn-sm btn-sm-bl" mdbWavesEffect (click)="interruptProcess()">
                Intrerupere
            </button>
        </div>
    </form>
</div>